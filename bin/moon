#!/usr/bin/env lua

require "alt_getopt"

local util = require "moonscript.util"


local unpack = util.unpack

local loader = require "moonscript.loader"


-- moonloader and repl
local opts, ind = alt_getopt.get_opts(arg, "cvhd", { version = "v", help = "h" })

local help = [=[Usage: %s [options] [script [args]]

    -h          Print this message
    -d          Disable stack trace rewriting
    -c          Collect and print code coverage
    -v          Print version
]=]

local function print_err(...)
	local msg = table.concat({...}, "\t")
	io.stderr:write(msg .. "\n")
end

local function print_help(err)
	if err then print("Error: "..err) end
	print(help:format(arg[0]))
	os.exit()
end

if opts.h then print_help() end

if opts.v then
	local v = require "moonscript.version"
	v.print_version()
	os.exit()
end

local script_fname = arg[ind]
if not script_fname then
	print_help("repl not yet supported")
	return
end

local new_arg = {
	[-1] = arg[0],
	[0] = arg[ind],
	select(ind + 1, unpack(arg))
}

if not loader.load(script_fname, {}, new_arg) then exit(1) end